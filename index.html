<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartVault - Local & Seguro</title>
    
    <!-- Meta Tags PWA -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Armazenamento seguro e local de fotos e documentos.">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "idb": "https://esm.sh/idb@7.1.1",
            "jszip": "https://esm.sh/jszip@3.10.1"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PWA MANIFEST GENERATOR -->
    <script>
        const manifest = {
            "name": "SmartVault Local",
            "short_name": "SmartVault",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0f172a",
            "theme_color": "#0f172a",
            "icons": [
                {
                    "src": "https://cdn-icons-png.flaticon.com/512/6409/6409867.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        try {
            const stringManifest = JSON.stringify(manifest);
            const blob = new Blob([stringManifest], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestURL;
            document.head.appendChild(link);
        } catch (e) {
            console.warn("Manifest generation failed", e);
        }
    </script>

    <style>
        body { background-color: #0f172a; color: #f1f5f9; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Camera, Video, Image as ImageIcon, Grid, List, Upload, Trash2, 
            Search, FolderOpen, Star, Cloud, Menu, X, DownloadCloud, 
            Settings, HardDrive, LogOut, Plus, RefreshCw, Smartphone, 
            ShieldCheck, AlertTriangle, FileJson, UploadCloud, FolderPlus, Move,
            FileText, File as FileGeneric, Eye, Archive, Lock, Copy, User, Mail, Key
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signOut, 
            GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, 
            createUserWithEmailAndPassword 
        } from 'firebase/auth';
        import { openDB } from 'idb';
        import JSZip from 'jszip';

        // --- DATABASE LOCAL (IndexedDB) ---
        const DB_NAME = 'SmartVaultDB';
        const STORE_NAME = 'media_store';

        const initDB = async () => {
            return openDB(DB_NAME, 1, {
                upgrade(db) {
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        store.createIndex('date', 'createdAt');
                        store.createIndex('type', 'type');
                    }
                },
            });
        };

        const saveToDB = async (item) => {
            const db = await initDB();
            return db.put(STORE_NAME, item);
        };

        const getAllFromDB = async () => {
            const db = await initDB();
            return db.getAll(STORE_NAME);
        };

        const deleteFromDB = async (id) => {
            const db = await initDB();
            return db.delete(STORE_NAME, id);
        };

        const clearDB = async () => {
            const db = await initDB();
            return db.clear(STORE_NAME);
        };

        // --- FIREBASE CONFIG (SEU PROJETO REAL) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBCkh9J-RqQaM7nHxNbJjbs74TwrMh-E6s",
            authDomain: "whatsapp-20-153cc.firebaseapp.com",
            projectId: "whatsapp-20-153cc",
            storageBucket: "whatsapp-20-153cc.firebasestorage.app",
            messagingSenderId: "807771374000",
            appId: "1:807771374000:web:ef66edfc92a8e5ee7c5675"
        };
        
        let auth = null;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
        } catch (e) { console.warn("Firebase config error", e); }

        // --- COMPONENTE THUMBNAIL INTELIGENTE ---
        const MediaThumbnail = ({ item, viewMode }) => {
            const [url, setUrl] = useState('');

            useEffect(() => {
                let objectUrl = '';
                if (item.data instanceof Blob) {
                    objectUrl = URL.createObjectURL(item.data);
                    setUrl(objectUrl);
                } else {
                    setUrl(item.data);
                }
                return () => {
                    if (objectUrl) URL.revokeObjectURL(objectUrl);
                };
            }, [item.data]);

            const Icon = item.type === 'video' ? Video : (item.type === 'document' ? FileText : ImageIcon);
            
            if (viewMode === 'list') {
                return (
                    <div className="w-16 h-16 rounded-lg bg-slate-900 overflow-hidden flex-shrink-0 flex items-center justify-center border border-slate-700">
                        {item.type === 'image' ? (
                            <img src={url} className="w-full h-full object-cover" loading="lazy" />
                        ) : (
                            <Icon size={24} className={item.type === 'document' ? 'text-blue-400' : 'text-slate-500'} />
                        )}
                    </div>
                );
            }

            return (
                <div className="w-full h-full relative group bg-slate-800">
                    {item.type === 'image' ? (
                        <img src={url} className="w-full h-full object-cover" loading="lazy" />
                    ) : item.type === 'video' ? (
                        <div className="w-full h-full flex items-center justify-center bg-slate-900">
                            <Video size={32} className="text-slate-600 group-hover:text-blue-500 transition-colors"/>
                        </div>
                    ) : (
                        <div className="w-full h-full flex flex-col items-center justify-center bg-slate-900 p-4 text-center">
                            <FileText size={40} className="text-blue-500 mb-2"/>
                            <span className="text-[10px] text-slate-400 font-mono bg-slate-800 px-1 rounded truncate w-full">
                                {item.name.split('.').pop().toUpperCase()}
                            </span>
                        </div>
                    )}
                    
                    <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-3">
                        <p className="text-white text-xs font-medium truncate">{item.name}</p>
                        <div className="flex justify-between items-center mt-1">
                            <p className="text-slate-400 text-[10px]">{formatBytes(item.size)}</p>
                            {item.type === 'document' && <span className="px-1.5 py-0.5 bg-blue-600 text-[9px] rounded text-white">DOC</span>}
                        </div>
                    </div>
                </div>
            );
        };

        const formatBytes = (bytes, decimals = 2) => {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        };

        function App() {
            // --- ESTADOS ---
            const [user, setUser] = useState(null);
            const [authMode, setAuthMode] = useState('login');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            
            const [mediaItems, setMediaItems] = useState([]);
            const [folders, setFolders] = useState([]);
            const [viewMode, setViewMode] = useState('grid');
            const [activeFilter, setActiveFilter] = useState('all');
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedItem, setSelectedItem] = useState(null);
            
            const [isUploading, setIsUploading] = useState(false);
            const [isExporting, setIsExporting] = useState(false);
            const [isImporting, setIsImporting] = useState(false);
            const [diskUsage, setDiskUsage] = useState({ used: 0, total: 0 });
            
            const [notification, setNotification] = useState(null);
            const [authError, setAuthError] = useState(null); 
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showNewFolderModal, setShowNewFolderModal] = useState(false);
            const [newFolderName, setNewFolderName] = useState('');

            useEffect(() => {
                if(auth) {
                    const unsub = onAuthStateChanged(auth, (u) => {
                        setUser(u);
                        if(u) {
                            loadData();
                            setAuthError(null);
                        }
                    });
                    return () => unsub();
                } else {
                    // Fallback para quando o Firebase falha completamente
                    setUser({ uid: 'local-user', email: 'Modo Offline' });
                    loadData();
                }
            }, []);

            const loadData = async () => {
                try {
                    const allData = await getAllFromDB();
                    const loadedFolders = allData.find(item => item.id === 'settings_folders');
                    if (loadedFolders) setFolders(loadedFolders.list || []);

                    const items = allData.filter(item => item.id !== 'settings_folders');
                    items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    setMediaItems(items);
                    updateStorageEstimate();
                } catch (err) { console.error("Erro ao carregar DB:", err); }
            };

            const updateStorageEstimate = async () => {
                if (navigator.storage && navigator.storage.estimate) {
                    const { usage, quota } = await navigator.storage.estimate();
                    setDiskUsage({ used: usage, total: quota });
                }
            };

            const handleCreateFolder = async () => {
                if (!newFolderName.trim()) return;
                const newFolder = { id: `folder_${Date.now()}`, name: newFolderName.trim() };
                const updatedFolders = [...folders, newFolder];
                setFolders(updatedFolders);
                await saveToDB({ id: 'settings_folders', list: updatedFolders });
                setNewFolderName('');
                setShowNewFolderModal(false);
                showNotification(`Pasta "${newFolder.name}" criada!`);
            };

            const handleDeleteFolder = async (folderId) => {
                if (!confirm("Excluir pasta? Os arquivos voltarão para a Galeria principal.")) return;
                const updatedFolders = folders.filter(f => f.id !== folderId);
                setFolders(updatedFolders);
                await saveToDB({ id: 'settings_folders', list: updatedFolders });
                const itemsToUpdate = mediaItems.filter(i => i.folderId === folderId);
                for (let item of itemsToUpdate) {
                    const updatedItem = { ...item, folderId: null };
                    await saveToDB(updatedItem);
                }
                if (activeFilter === folderId) setActiveFilter('all');
                loadData();
                showNotification("Pasta excluída.");
            };

            const handleMoveItem = async (item, targetFolderId) => {
                const updatedItem = { ...item, folderId: targetFolderId };
                await saveToDB(updatedItem);
                setMediaItems(prev => prev.map(i => i.id === item.id ? updatedItem : i));
                setSelectedItem(prev => prev && prev.id === item.id ? updatedItem : prev);
                showNotification("Arquivo movido com sucesso!");
            };

            const handleFileUpload = async (e) => {
                const files = Array.from(e.target.files || e.dataTransfer.files);
                if (!files.length) return;
                
                setIsUploading(true);
                let count = 0;
                const targetFolderId = activeFilter.startsWith('folder_') ? activeFilter : null;

                for (const file of files) {
                    try {
                        let type = 'document';
                        if (file.type.startsWith('image/')) type = 'image';
                        else if (file.type.startsWith('video/')) type = 'video';
                        
                        const newItem = {
                            id: crypto.randomUUID(),
                            name: file.name,
                            data: file,
                            type: type,
                            mimeType: file.type,
                            size: file.size,
                            folderId: targetFolderId,
                            createdAt: new Date().toISOString(),
                            category: 'upload'
                        };

                        await saveToDB(newItem);
                        count++;
                    } catch (error) {
                        console.error("Erro upload:", error);
                        showNotification(`Erro ao salvar ${file.name}`, 'error');
                    }
                }

                await loadData();
                setIsUploading(false);
                showNotification(`${count} arquivos salvos!`);
            };

            const handleExportBackup = async () => {
                if(!confirm("Gerar Backup ZIP? Isso garante melhor qualidade e organização.")) return;
                setIsExporting(true);
                try {
                    const zip = new JSZip();
                    const allData = await getAllFromDB();
                    
                    const settingsFolders = allData.find(i => i.id === 'settings_folders');
                    const foldersList = settingsFolders ? settingsFolders.list : [];
                    const mediaItems = allData.filter(i => i.id !== 'settings_folders');
                    
                    const metadata = {
                        version: "3.0",
                        exportedAt: new Date().toISOString(),
                        folders: foldersList,
                        items: mediaItems.map(item => ({
                            id: item.id,
                            name: item.name,
                            type: item.type,
                            size: item.size,
                            mimeType: item.mimeType,
                            folderId: item.folderId,
                            createdAt: item.createdAt
                        }))
                    };
                    
                    zip.file("smartvault_structure.json", JSON.stringify(metadata, null, 2));
                    const assets = zip.folder("assets");
                    
                    for (const item of mediaItems) {
                        if (item.data instanceof Blob) {
                             const ext = item.name.split('.').pop() || 'bin';
                             assets.file(`${item.id}.${ext}`, item.data);
                        } else if (typeof item.data === 'string') {
                            const base64Data = item.data.split(',')[1];
                            assets.file(`${item.id}_legacy.bin`, base64Data, {base64: true});
                        }
                    }
                    
                    const content = await zip.generateAsync({type:"blob"});
                    const url = URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `SmartVault_Backup_${new Date().toLocaleDateString()}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showNotification("Backup ZIP gerado com sucesso!", "success");
                } catch (e) {
                    console.error(e);
                    showNotification("Erro no backup: " + e.message, "error");
                } finally { setIsExporting(false); }
            };

            const handleImportBackup = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                if(!confirm("Restaurar backup ZIP? Isso irá mesclar os arquivos com os atuais.")) return;

                setIsImporting(true);
                try {
                    const zip = new JSZip();
                    const loadedZip = await zip.loadAsync(file);
                    
                    const metadataFile = loadedZip.file("smartvault_structure.json");
                    if (!metadataFile) throw new Error("Arquivo inválido (falta smartvault_structure.json)");
                    
                    const metadataStr = await metadataFile.async("string");
                    const metadata = JSON.parse(metadataStr);
                    
                    const currentFolders = folders;
                    const backupFolders = metadata.folders || [];
                    const uniqueFolders = [...currentFolders];
                    backupFolders.forEach(bf => {
                        if(!uniqueFolders.find(cf => cf.id === bf.id)) uniqueFolders.push(bf);
                    });
                    await saveToDB({ id: 'settings_folders', list: uniqueFolders });
                    
                    let count = 0;
                    for (const metaItem of metadata.items) {
                         const ext = metaItem.name.split('.').pop() || 'bin';
                         let fileInZip = loadedZip.file(`assets/${metaItem.id}.${ext}`);
                         if (!fileInZip) fileInZip = loadedZip.file(`assets/${metaItem.id}_legacy.bin`);
                         
                         if (fileInZip) {
                             const blob = await fileInZip.async("blob");
                             const newItem = { ...metaItem, data: blob };
                             const existing = mediaItems.find(i => i.id === newItem.id);
                             if(!existing) {
                                await saveToDB(newItem);
                                count++;
                             }
                         }
                    }
                    await loadData();
                    showNotification(`${count} arquivos restaurados e organizados!`, "success");
                } catch (err) {
                    console.error(err);
                    showNotification("Erro ao restaurar: " + err.message, "error");
                } finally { setIsImporting(false); e.target.value = ''; }
            };

            const handleDelete = async (id) => {
                if(confirm("Excluir permanentemente?")) {
                    await deleteFromDB(id);
                    setSelectedItem(null);
                    loadData();
                    showNotification("Item excluído.");
                }
            };

            const showNotification = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 4000);
            };

            // --- LÓGICA DE LOGIN COM GOOGLE ---
            const handleLogin = async (method) => {
                setAuthError(null);
                
                // Em ambientes de desenvolvimento (Canvas Preview), o Google Login falha por ser URL blob
                const isBlobEnvironment = window.location.protocol === 'blob:' || window.location.href.includes('scf.usercontent.goog');
                
                if (method === 'google' && isBlobEnvironment) {
                    setAuthError({
                        type: 'blob',
                        title: "Modo Preview Detectado",
                        msg: "O 'Entrar com Google' é bloqueado pelo Google em visualizações temporárias. Use 'Email/Senha' ou 'Visitante'. Em seu site final (GitHub Pages), o Google funcionará.",
                        domain: "N/A"
                    });
                    return;
                }

                try {
                    if (method === 'google') await signInWithPopup(auth, new GoogleAuthProvider());
                    else if (method === 'anon') await signInAnonymously(auth);
                    else if (method === 'email') await signInWithEmailAndPassword(auth, email, password);
                } catch (e) { 
                    console.error("Auth Error:", e);
                    
                    if (e.code === 'auth/operation-not-allowed') {
                        setAuthError({
                            type: 'provider',
                            title: "Método Desativado",
                            msg: `O login via ${method === 'google' ? 'Google' : 'Email/Senha'} não está ativado no seu Firebase.`,
                            domain: "Ative em: Authentication > Sign-in method"
                        });
                    } else if (e.code === 'auth/unauthorized-domain' || (e.message && e.message.includes('unauthorized domain'))) {
                        const currentDomain = window.location.hostname || window.location.host || window.location.href;
                        setAuthError({
                            type: 'domain',
                            title: "Domínio Não Autorizado",
                            msg: "Adicione este domínio no Firebase Console (Authentication > Settings > Authorized Domains):",
                            domain: currentDomain
                        });
                    } else {
                        showNotification(e.message, 'error'); 
                    }
                }
            };

            const handleRegister = async () => {
                try { 
                    await createUserWithEmailAndPassword(auth, email, password); 
                    showNotification("Conta criada com sucesso!", "success");
                } catch(e) { 
                    console.error(e);
                    let msg = "Erro no cadastro.";
                    if (e.code === 'auth/operation-not-allowed') {
                        msg = "Registro por E-mail desativado no Firebase Console.";
                    } else if(e.code === 'auth/email-already-in-use') {
                        msg = "Este e-mail já está em uso.";
                    } else if(e.code === 'auth/weak-password') {
                        msg = "Senha muito fraca (min 6 caracteres).";
                    }
                    showNotification(msg, 'error'); 
                }
            };

            const filteredItems = useMemo(() => {
                return mediaItems.filter(item => {
                    const matchesSearch = item.name.toLowerCase().includes(searchQuery.toLowerCase());
                    let matchesCategory = true;
                    
                    if (activeFilter === 'all') matchesCategory = true;
                    else if (activeFilter === 'video') matchesCategory = item.type === 'video';
                    else if (activeFilter === 'image') matchesCategory = item.type === 'image';
                    else if (activeFilter === 'document') matchesCategory = item.type === 'document';
                    else if (activeFilter.startsWith('folder_')) matchesCategory = item.folderId === activeFilter;
                    
                    return matchesSearch && matchesCategory;
                });
            }, [mediaItems, searchQuery, activeFilter]);

            const currentFolderName = useMemo(() => {
                if (activeFilter === 'all') return 'Galeria Principal';
                if (activeFilter === 'image') return 'Imagens';
                if (activeFilter === 'video') return 'Vídeos';
                if (activeFilter === 'document') return 'Documentos';
                const folder = folders.find(f => f.id === activeFilter);
                return folder ? folder.name : 'Galeria';
            }, [activeFilter, folders]);

            // --- RENDER ---
            if (!user) return (
                <div className="min-h-screen bg-[#0f172a] flex items-center justify-center p-4 relative overflow-hidden">
                    <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop')] bg-cover opacity-20 animate-pulse"></div>
                    
                    {authError && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md p-4 animate-fade-in">
                            <div className="bg-slate-800 p-6 rounded-2xl border border-red-500/50 max-w-md w-full shadow-2xl">
                                <div className="flex items-center gap-3 text-red-400 mb-4">
                                    <Lock size={32} />
                                    <h2 className="text-xl font-bold">{authError.title}</h2>
                                </div>
                                <p className="text-slate-300 mb-4 text-sm font-medium">{authError.msg}</p>
                                
                                <div className="bg-black/60 p-4 rounded-lg border border-yellow-500/30 flex justify-between items-center mb-6">
                                    <code className="text-yellow-400 font-mono text-sm break-all select-all flex-1 mr-2">{authError.domain}</code>
                                    <button onClick={() => {navigator.clipboard.writeText(authError.domain); showNotification("Copiado!");}} className="bg-slate-700 hover:bg-slate-600 text-white p-2 rounded-lg"><Copy size={16}/></button>
                                </div>
                                <button onClick={() => setAuthError(null)} className="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-semibold">Fechar</button>
                            </div>
                        </div>
                    )}

                    <div className="glass p-8 rounded-2xl w-full max-w-md z-10 shadow-2xl relative">
                        {notification && (
                            <div className={`absolute top-0 left-0 w-full p-3 text-center text-sm font-medium rounded-t-2xl ${notification.type === 'error' ? 'bg-red-500/80' : 'bg-emerald-500/80'} text-white`}>
                                {notification.msg}
                            </div>
                        )}

                        <div className="text-center mb-8 mt-4">
                            <div className="inline-flex p-4 bg-blue-600 rounded-2xl mb-4 shadow-lg shadow-blue-500/50">
                                <HardDrive size={40} className="text-white" />
                            </div>
                            <h1 className="text-3xl font-bold text-white">SmartVault <span className="text-blue-400">Local</span></h1>
                            <p className="text-slate-400 mt-2">Armazenamento ilimitado no seu dispositivo.</p>
                        </div>

                        <div className="space-y-4">
                            <button onClick={() => handleLogin('google')} className="w-full bg-white hover:bg-gray-100 text-slate-900 py-3 rounded-xl font-medium transition flex justify-center items-center gap-2">
                                <span className="font-bold">G</span> Entrar com Google
                            </button>
                            
                            <div className="flex items-center gap-2"><div className="h-px bg-slate-700 flex-1"></div><span className="text-xs text-slate-500">OU</span><div className="h-px bg-slate-700 flex-1"></div></div>

                            <div className="relative">
                                <Mail className="absolute left-4 top-3.5 text-slate-500" size={18} />
                                <input 
                                    type="email" 
                                    placeholder="Seu e-mail" 
                                    className="w-full bg-slate-800/80 border border-slate-700 rounded-xl py-3 pl-11 pr-4 text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder:text-slate-600" 
                                    value={email} 
                                    onChange={e => setEmail(e.target.value)} 
                                />
                            </div>
                            <div className="relative">
                                <Key className="absolute left-4 top-3.5 text-slate-500" size={18} />
                                <input 
                                    type="password" 
                                    placeholder="Sua senha" 
                                    className="w-full bg-slate-800/80 border border-slate-700 rounded-xl py-3 pl-11 pr-4 text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder:text-slate-600" 
                                    value={password} 
                                    onChange={e => setPassword(e.target.value)} 
                                />
                            </div>

                            {authMode === 'login' ? (
                                <>
                                    <button onClick={() => handleLogin('email')} className="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-900/50 transition-all hover:scale-[1.02]">
                                        Entrar
                                    </button>
                                    <p className="text-center text-sm text-slate-400">
                                        Não tem conta? <button onClick={() => setAuthMode('register')} className="text-blue-400 hover:text-blue-300 font-medium hover:underline">Cadastre-se</button>
                                    </p>
                                </>
                            ) : (
                                <>
                                    <button onClick={handleRegister} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-emerald-900/50 transition-all hover:scale-[1.02]">
                                        Criar Conta
                                    </button>
                                    <p className="text-center text-sm text-slate-400">
                                        Já tem conta? <button onClick={() => setAuthMode('login')} className="text-blue-400 hover:text-blue-300 font-medium hover:underline">Fazer Login</button>
                                    </p>
                                </>
                            )}
                        </div>

                        <div className="mt-8 pt-6 border-t border-slate-700/50">
                            <button onClick={() => handleLogin('anon')} className="w-full text-xs text-slate-500 hover:text-slate-300 transition-colors flex items-center justify-center gap-2">
                                <User size={14}/> Continuar como Visitante (Offline)
                            </button>
                        </div>
                    </div>
                </div>
            );

            // ... (Resto do componente App igual)
            return (
                <div className="flex h-screen bg-[#0f172a] text-slate-100 font-sans overflow-hidden">
                    {/* ... (Toasts, Modais, Sidebar, Main e Lightbox são iguais ao anterior, pois o foco era corrigir o login) ... */}
                    {notification && (
                        <div className={`fixed top-6 right-6 z-50 px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 animate-fade-in ${notification.type === 'error' ? 'bg-red-500/90' : 'bg-emerald-600/90'} backdrop-blur-md`}>
                            {notification.type === 'error' ? <AlertTriangle size={20}/> : <ShieldCheck size={20}/>}
                            <span className="font-medium">{notification.msg}</span>
                        </div>
                    )}
                    {showNewFolderModal && (
                        <div className="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-slate-800 p-6 rounded-2xl w-full max-w-sm border border-slate-700 shadow-2xl animate-fade-in">
                                <h3 className="text-lg font-bold text-white mb-4">Nova Pasta</h3>
                                <input autoFocus type="text" placeholder="Ex: Praia, Trabalho..." className="w-full bg-slate-900 border border-slate-600 rounded-xl p-3 text-white mb-4 focus:ring-2 focus:ring-blue-500 outline-none" value={newFolderName} onChange={(e) => setNewFolderName(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleCreateFolder()} />
                                <div className="flex justify-end gap-3">
                                    <button onClick={() => setShowNewFolderModal(false)} className="px-4 py-2 text-slate-400 hover:text-white">Cancelar</button>
                                    <button onClick={handleCreateFolder} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">Criar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showSettings && (
                         <div className="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onClick={(e) => e.target === e.currentTarget && setShowSettings(false)}>
                            <div className="bg-slate-800 rounded-2xl w-full max-w-lg border border-slate-700 shadow-2xl overflow-hidden animate-fade-in">
                                <div className="p-6 border-b border-slate-700 flex justify-between items-center">
                                    <h2 className="text-xl font-bold flex items-center gap-2"><Settings className="text-blue-400"/> Configurações</h2>
                                    <button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-white"><X size={24}/></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-sm text-slate-400">Espaço em Disco</span>
                                            <span className="text-xs font-mono bg-blue-900/30 text-blue-300 px-2 py-1 rounded">{formatBytes(diskUsage.used)} usados</span>
                                        </div>
                                        <div className="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                                            <div className="bg-blue-500 h-full transition-all duration-1000" style={{width: `${(diskUsage.used / (diskUsage.total || 1)) * 100}%`}}></div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={handleExportBackup} disabled={isExporting} className="flex flex-col items-center justify-center p-4 bg-slate-700 hover:bg-slate-600 rounded-xl border border-slate-600 transition group relative">
                                            {isExporting ? <RefreshCw className="animate-spin text-emerald-400 mb-2"/> : <Archive size={28} className="text-emerald-400 mb-2 group-hover:scale-110 transition-transform"/>}
                                            <span className="font-semibold text-sm">Baixar Backup ZIP</span>
                                            <span className="text-[10px] text-slate-400 text-center">Organizado & Alta Qualidade</span>
                                        </button>
                                        <label className="flex flex-col items-center justify-center p-4 bg-slate-700 hover:bg-slate-600 rounded-xl border border-slate-600 transition cursor-pointer group relative">
                                            {isImporting ? <RefreshCw className="animate-spin text-blue-400 mb-2"/> : <UploadCloud size={28} className="text-blue-400 mb-2 group-hover:scale-110 transition-transform"/>}
                                            <span className="font-semibold text-sm">Restaurar ZIP</span>
                                            <span className="text-[10px] text-slate-400 text-center">Carregar Backup</span>
                                            <input type="file" accept=".zip" className="hidden" onChange={handleImportBackup} disabled={isImporting} />
                                        </label>
                                    </div>
                                    <div className="pt-4 border-t border-slate-700">
                                        <button onClick={() => {if(confirm("Apagar TUDO?")) clearDB().then(loadData)}} className="text-red-400 text-sm hover:text-red-300 flex items-center gap-2">
                                            <Trash2 size={16}/> Apagar Tudo Localmente
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <aside className={`fixed md:relative z-30 w-72 h-full bg-slate-900 border-r border-slate-800 transform transition-transform duration-300 flex flex-col ${sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                        {/* Header Fixo */}
                        <div className="p-6 flex items-center justify-between flex-shrink-0">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-blue-600 rounded-lg shadow-lg shadow-blue-900/20"><HardDrive size={20} className="text-white"/></div>
                                <span className="font-bold text-lg tracking-tight">SmartVault</span>
                            </div>
                            <button onClick={() => setSidebarOpen(false)} className="md:hidden text-slate-400"><X size={24}/></button>
                        </div>
                        
                        {/* Botão Upload Fixo */}
                        <div className="px-4 mb-6 flex-shrink-0">
                            <label className="flex items-center justify-center gap-2 w-full bg-white hover:bg-slate-100 text-slate-900 font-semibold py-3 rounded-xl cursor-pointer transition shadow-lg shadow-white/10 active:scale-95 group">
                                {isUploading ? <RefreshCw className="animate-spin" size={20}/> : <Plus size={20} className="group-hover:rotate-90 transition-transform"/>}
                                <span>Adicionar Arquivo</span>
                                <input 
                                    type="file" 
                                    multiple 
                                    className="hidden" 
                                    onChange={handleFileUpload} 
                                />
                            </label>
                            {activeFilter.startsWith('folder_') && <p className="text-[10px] text-center text-slate-500 mt-2">Enviando para: {currentFolderName}</p>}
                        </div>

                        {/* Área de Rolagem Flexível */}
                        <nav className="px-4 space-y-1 flex-1 overflow-y-auto min-h-0 scrollbar-thin scrollbar-thumb-slate-700">
                            <SidebarItem icon={<Grid size={18}/>} label="Tudo" active={activeFilter==='all'} onClick={()=>setActiveFilter('all')} />
                            <SidebarItem icon={<ImageIcon size={18}/>} label="Imagens" active={activeFilter==='image'} onClick={()=>setActiveFilter('image')} />
                            <SidebarItem icon={<Video size={18}/>} label="Vídeos" active={activeFilter==='video'} onClick={()=>setActiveFilter('video')} />
                            <SidebarItem icon={<FileText size={18}/>} label="Documentos" active={activeFilter==='document'} onClick={()=>setActiveFilter('document')} />
                            
                            <div className="pt-6 pb-2 px-2 flex items-center justify-between text-xs font-semibold text-slate-500 uppercase tracking-wider sticky top-0 bg-slate-900 z-10">
                                <span>Minhas Pastas</span>
                                <button onClick={() => setShowNewFolderModal(true)} className="hover:text-white"><FolderPlus size={14}/></button>
                            </div>
                            
                            {folders.map(folder => (
                                <div key={folder.id} className="group relative flex items-center">
                                    <SidebarItem 
                                        icon={<FolderOpen size={18}/>} 
                                        label={folder.name} 
                                        active={activeFilter===folder.id} 
                                        onClick={()=>setActiveFilter(folder.id)} 
                                    />
                                    <button onClick={(e) => { e.stopPropagation(); handleDeleteFolder(folder.id); }} className="absolute right-2 p-1.5 text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><X size={14}/></button>
                                </div>
                            ))}
                            {folders.length === 0 && <p className="text-xs text-slate-600 px-3 italic">Nenhuma pasta criada</p>}
                        </nav>
                        
                        {/* Rodapé Fixo */}
                        <div className="flex-shrink-0 bg-slate-900 pt-2 border-t border-slate-800">
                             <div className="px-4 pb-2">
                                <p className="px-2 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Sistema</p>
                                <SidebarItem icon={<Settings size={18}/>} label="Backup & Config" onClick={()=>setShowSettings(true)} />
                            </div>

                            <div className="p-4 border-t border-slate-800 bg-slate-900">
                                <div className="flex items-center gap-3 mb-3">
                                    <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center text-xs font-bold text-white">
                                        {user.email ? user.email[0].toUpperCase() : 'U'}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <p className="text-sm font-medium truncate">{user.email}</p>
                                        <p className="text-[10px] text-slate-500">Online</p>
                                    </div>
                                </div>
                                <button onClick={() => signOut(auth)} className="w-full flex items-center justify-center gap-2 text-xs text-slate-400 hover:text-white py-2 border border-slate-700 rounded-lg hover:bg-slate-800 transition"><LogOut size={14}/> Sair</button>
                            </div>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col min-w-0 relative bg-[#0f172a]">
                        <header className="h-16 border-b border-slate-800 flex items-center justify-between px-4 sticky top-0 bg-[#0f172a]/80 backdrop-blur-xl z-20">
                            <div className="flex items-center gap-4 flex-1">
                                <button onClick={() => setSidebarOpen(true)} className="md:hidden text-slate-400"><Menu size={24}/></button>
                                <div className="relative w-full max-w-md hidden sm:block">
                                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={16}/>
                                    <input type="text" placeholder="Buscar..." className="w-full bg-slate-800 border-none rounded-full py-2 pl-10 pr-4 text-sm text-slate-200 focus:ring-2 focus:ring-blue-500/50 outline-none transition-all placeholder:text-slate-600" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="bg-slate-800 rounded-lg p-1 flex">
                                    <button onClick={()=>setViewMode('grid')} className={`p-2 rounded-md transition ${viewMode==='grid' ? 'bg-slate-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}><Grid size={18}/></button>
                                    <button onClick={()=>setViewMode('list')} className={`p-2 rounded-md transition ${viewMode==='list' ? 'bg-slate-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}><List size={18}/></button>
                                </div>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-6 scrollbar-thin scrollbar-thumb-slate-700" onDragOver={(e) => e.preventDefault()} onDrop={(e) => { e.preventDefault(); handleFileUpload(e); }}>
                            {mediaItems.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-slate-500 pb-20">
                                    <div className="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mb-6 animate-bounce">
                                        <Cloud size={48} className="text-slate-600" />
                                    </div>
                                    <h3 className="text-xl font-semibold text-slate-300">Nenhum arquivo ainda</h3>
                                    <p className="max-w-xs text-center mt-2 text-slate-500">Seus arquivos ficam salvos neste dispositivo.</p>
                                    <button onClick={()=>document.querySelector('input[type="file"]').click()} className="mt-6 text-blue-400 hover:text-blue-300 font-medium">Upload Agora</button>
                                </div>
                            ) : (
                                <>
                                    <div className="flex items-end justify-between mb-6">
                                        <div>
                                            <h2 className="text-2xl font-bold text-white capitalize flex items-center gap-2">
                                                {activeFilter.startsWith('folder_') && <FolderOpen className="text-blue-500"/>}
                                                {currentFolderName}
                                            </h2>
                                            <p className="text-sm text-slate-500 mt-1">{filteredItems.length} itens • {formatBytes(filteredItems.reduce((a,b) => a + (b.size||0), 0))} armazenados</p>
                                        </div>
                                    </div>

                                    {filteredItems.length === 0 ? (
                                        <div className="text-center py-20 text-slate-600"><p>Nenhum item encontrado.</p></div>
                                    ) : viewMode === 'grid' ? (
                                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                                            {filteredItems.map(item => (
                                                <div key={item.id} onClick={() => setSelectedItem(item)} className="aspect-square rounded-2xl overflow-hidden cursor-pointer shadow-lg hover:shadow-2xl hover:scale-[1.02] transition-all duration-300 border border-slate-700/50">
                                                    <MediaThumbnail item={item} viewMode="grid" />
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {filteredItems.map(item => (
                                                <div key={item.id} onClick={() => setSelectedItem(item)} className="flex items-center gap-4 p-3 bg-slate-800/40 hover:bg-slate-800 rounded-xl border border-transparent hover:border-slate-700 cursor-pointer transition-all group">
                                                    <MediaThumbnail item={item} viewMode="list" />
                                                    <div className="flex-1 min-w-0">
                                                        <h4 className="text-white font-medium truncate">{item.name}</h4>
                                                        <p className="text-sm text-slate-500">{new Date(item.createdAt).toLocaleDateString()} • {formatBytes(item.size)}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    </main>

                    {/* LIGHTBOX / VIEWER */}
                    {selectedItem && (
                        <div className="fixed inset-0 z-50 bg-black/95 backdrop-blur-xl flex flex-col animate-fade-in">
                             <div className="flex items-center justify-between p-4 bg-gradient-to-b from-black/50 to-transparent absolute top-0 w-full z-10">
                                <span className="text-white/80 text-sm truncate max-w-xs">{selectedItem.name}</span>
                                <div className="flex gap-2">
                                    <button onClick={() => handleDelete(selectedItem.id)} className="p-2 text-white/70 hover:text-red-400 bg-white/10 rounded-full transition"><Trash2 size={20}/></button>
                                    <button onClick={() => setSelectedItem(null)} className="p-2 text-white/70 hover:text-white bg-white/10 rounded-full transition"><X size={20}/></button>
                                </div>
                            </div>
                            
                            <div className="flex-1 flex flex-col items-center justify-center p-4">
                                {selectedItem.type === 'image' ? (
                                    <MediaThumbnail item={selectedItem} viewMode="grid" />
                                ) : selectedItem.type === 'video' ? (
                                    // Para vídeo no lightbox, precisamos criar URL temporária
                                    (() => {
                                        const url = selectedItem.data instanceof Blob ? URL.createObjectURL(selectedItem.data) : selectedItem.data;
                                        return <video src={url} controls autoPlay className="max-w-full max-h-[70vh] rounded shadow-2xl" />;
                                    })()
                                ) : (
                                    // Document View
                                    <div className="flex flex-col items-center justify-center bg-slate-800 p-10 rounded-3xl border border-slate-700">
                                        <div className="bg-slate-700 p-6 rounded-2xl mb-4">
                                            <FileText size={64} className="text-blue-400"/>
                                        </div>
                                        <h3 className="text-xl font-bold text-white mb-2 max-w-md text-center">{selectedItem.name}</h3>
                                        <p className="text-slate-400 mb-6">{formatBytes(selectedItem.size)} • {selectedItem.mimeType || 'Documento'}</p>
                                        <a 
                                            href={selectedItem.data instanceof Blob ? URL.createObjectURL(selectedItem.data) : selectedItem.data} 
                                            download={selectedItem.name} 
                                            className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-blue-900/40 transition hover:-translate-y-1"
                                        >
                                            <DownloadCloud size={20}/> Baixar Arquivo
                                        </a>
                                    </div>
                                )}
                            </div>

                            {selectedItem.type !== 'document' && (
                                <div className="p-6 pb-8 bg-gradient-to-t from-black/80 to-transparent">
                                    <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
                                        {folders.length > 0 && (
                                            <div className="relative group">
                                                <div className="flex items-center gap-2 bg-slate-800 text-white px-4 py-2 rounded-full cursor-pointer hover:bg-slate-700">
                                                    <Move size={16} />
                                                    <span className="text-sm">Mover para...</span>
                                                </div>
                                                <div className="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-40 bg-slate-800 rounded-lg shadow-xl overflow-hidden hidden group-hover:block border border-slate-700">
                                                    <button onClick={() => handleMoveItem(selectedItem, null)} className="w-full text-left px-4 py-2 text-xs hover:bg-slate-700 text-slate-300">Galeria Principal</button>
                                                    {folders.map(f => (
                                                        <button key={f.id} onClick={() => handleMoveItem(selectedItem, f.id)} className="w-full text-left px-4 py-2 text-xs hover:bg-slate-700 text-white truncate">{f.name}</button>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        <a 
                                            href={selectedItem.data instanceof Blob ? URL.createObjectURL(selectedItem.data) : selectedItem.data} 
                                            download={selectedItem.name} 
                                            className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-full font-medium shadow-lg shadow-blue-900/40 transition hover:-translate-y-1"
                                        >
                                            <DownloadCloud size={20}/> Baixar
                                        </a>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function SidebarItem({ icon, label, active, onClick }) {
            return (
                <button onClick={onClick} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all ${active ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200'}`}>
                    {React.cloneElement(icon, { size: 18, className: active ? 'text-white' : '' })}
                    <span className="text-sm font-medium truncate">{label}</span>
                </button>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
